# Logonaut: Original Line Number Management

## Goal

Logonaut displays log entries that can be filtered in real-time. When filters are applied, the lines displayed in the editor may not be contiguous from the original log file. The goal is to display line numbers next to the log entries that correspond to their **original line number** in the full, unfiltered log file, rather than just numbering the visible (filtered) lines sequentially.

## Core Strategy

AvalonEdit's default line numbering (`ShowLineNumbers="True"`) simply numbers the lines currently present in its text buffer. Since Logonaut's text buffer contains only the *filtered* lines, this default numbering is not suitable.

To achieve the desired behavior, Logonaut implements the following strategy:

1.  **Disable AvalonEdit's built-in line numbers:** The `TextEditor` control in `MainWindow.xaml` has `ShowLineNumbers="False"`.
2.  **Preserve Original Line Numbers During Filtering:** The filtering process is modified to retain the original line number associated with each line that passes the filter (or is included as context).
3.  **Use a Custom Margin:** A dedicated custom UI element (`OriginalLineNumberMargin`) is added to the `TextArea.LeftMargins` collection. This margin is responsible *only* for drawing the line numbers.
4.  **Data Binding:** The custom margin receives the list of filtered lines (including their original numbers) from the `MainViewModel`.
5.  **Rendering Logic:** The custom margin renders the appropriate original line number next to each visible line drawn by the `TextView`.

## Key Components

*   **`LogDocument` (`Logonaut.Common`):** Stores the complete, original log content, implicitly numbering lines starting from 1 based on their position in its internal list.
*   **`FilteredLogLine` (`Logonaut.Common`):** A simple data structure created to hold both the `Text` of a log line *and* its `OriginalLineNumber` (1-based) from the `LogDocument`.
*   **`FilterEngine` (`Logonaut.Core`):** Modified `ApplyFilters` method. Instead of returning `IReadOnlyList<string>`, it now returns `IReadOnlyList<FilteredLogLine>`, populating the `OriginalLineNumber` property for each line added to the result set. It uses a `SortedDictionary<int, FilteredLogLine>` internally to ensure uniqueness based on original line number and maintain order.
*   **`MainViewModel` (`Logonaut.UI.ViewModels`):**
    *   Holds the result of the filtering process in the `FilteredLogLines` property (which is of type `IReadOnlyList<FilteredLogLine>`). This property is observable.
    *   Provides the text content to AvalonEdit via the `LogText` property, which is generated by joining the `Text` property of the `FilteredLogLines`.
*   **`OriginalLineNumberMargin` (`Logonaut.UI.Helpers`):**
    *   A custom control inheriting from `AbstractMargin`.
    *   Has a `FilteredLinesSource` dependency property which is bound to `MainViewModel.FilteredLogLines`.
    *   Overrides `OnRender` to draw the line numbers. It iterates through the `TextView.VisualLines` currently being rendered. For each `VisualLine`, it determines the corresponding `FilteredLogLine` based on the line's index within the *currently displayed text*. It then extracts and draws the `OriginalLineNumber` from that `FilteredLogLine`.
*   **`MainWindow.xaml` (`Logonaut.UI`):**
    *   Contains the `avalonedit:TextEditor` with `ShowLineNumbers="False"`.
    *   The `TextEditor.Document.Text` (via the helper `BindableText`) is bound to `MainViewModel.LogText`.
*   **`MainWindow.xaml.cs` (`Logonaut.UI`):**
    *   In the constructor (after `InitializeComponent`), programmatically creates an instance of `OriginalLineNumberMargin`.
    *   Adds this instance to the `LogOutputEditor.TextArea.LeftMargins` collection.
    *   Sets up the necessary data bindings in code between the `MainViewModel`'s properties (`FilteredLogLines`, `IsCustomLineNumberMarginVisible`) and the custom margin's dependency properties (`FilteredLinesSource`, `Visibility`).
    *   Adds a `DottedLineMargin` separator after the number margin for visual clarity.

## Detailed Data and Rendering Flow

1.  **Filtering:** The background filtering task in `MainViewModel` calls `FilterEngine.ApplyFilters`.
2.  **Data Generation:** `FilterEngine` iterates through the `LogDocument`. When a line matches (or is included as context), it creates a `FilteredLogLine` object containing the line's text and its original 1-based index (`j + 1`). These are stored uniquely (by original index) in a `SortedDictionary`.
3.  **ViewModel Update:** The `FilterEngine` returns an `IReadOnlyList<FilteredLogLine>`. This list is assigned to the `MainViewModel.FilteredLogLines` property on the UI thread.
4.  **Text Display Update:** The `MainViewModel` updates its `LogText` property by extracting and joining only the `Text` from the `FilteredLogLines`. Data binding updates the AvalonEdit `TextEditor` content. AvalonEdit renders *only the text*, without any built-in line numbers.
5.  **Margin Binding Update:** The update to `FilteredLogLines` notifies the `OriginalLineNumberMargin` via its data binding to the `FilteredLinesSource` property. The margin caches this list internally.
6.  **Margin Rendering:** When AvalonEdit renders or scrolls, the `TextView` calls `OnRender` for the `OriginalLineNumberMargin`.
    *   The margin gets the collection of currently visible `VisualLines` from the `TextView`.
    *   For each `VisualLine` being rendered, the margin calculates the index of that line *within the filtered document* (e.g., the 5th line visible on screen corresponds to the item at index 4 in the `FilteredLogLines` list).
    *   It retrieves the `FilteredLogLine` object from its cached list using this index (`_currentLinesCache[lineIndex]`).
    *   It extracts the `OriginalLineNumber` property from the `FilteredLogLine` object.
    *   It draws this number string onto the margin's drawing surface at the correct vertical position corresponding to the `VisualLine`.

## Benefits

*   **Accurate Numbering:** Line numbers always refer to the original file, regardless of filtering.
*   **Separation of Concerns:** The text display (AvalonEdit) is separate from the line number display (custom margin).
*   **Performance:** Filtering still happens in the background. The margin only needs to access its cached list of `FilteredLogLine` objects during rendering, which is efficient.